@page "/carrito"
@inject CartService Cart
@inject NavigationManager Nav
@inject AuthService Auth
@inject IOptions<ApiSettings> ApiSettings
@implements IAsyncDisposable
@using TentaloWebShop.Models
@using Microsoft.Extensions.Options
@using System.Globalization
@inject IJSRuntime JS
@inject LocalizationService L
@inject ProductService Products

<h1>@L.T("cart_title")</h1>

@if (!Cart.Items.Any())
{
    <div class="alert alert-info">@L.T("cart_empty")</div>
    <a class="btn btn-danger" href="/catalogo">@L.T("cart_go_to_catalog")</a>
}
else
{
    <!-- Overlay de procesamiento -->
    @if (isProcessingOrder)
    {
        <div class="processing-overlay">
            <div class="processing-modal">
                <div class="spinner-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">@L.T("loading")</span>
                    </div>
                </div>
                <h4 class="processing-title">@L.T("cart_processing")</h4>
                <p class="processing-text">@L.T("cart_processing_wait")</p>
            </div>
        </div>
    }

    <!-- Modal de resultado -->
    @if (orderCompleted)
    {
        <div class="result-overlay">
            <div class="result-modal">
                @if (orderSuccess)
                {
                    <div class="result-content success">
                        <div class="result-icon success-icon">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                        <h3 class="result-title">@L.T("cart_order_confirmed")</h3>
                        <p class="result-message">
                            @L.T("cart_order_success_text")<br />
                            @L.T("cart_order_email_text")
                        </p>
                        <div class="result-summary">
                            <div class="summary-item">
                                <strong>@L.T("cart_total"): @Cart.ImporteTotal.ToString("0.00") €</strong>
                            </div>
                            <div class="summary-item">
                                @L.T("cart_items"): @Cart.TotalQuantity
                            </div>
                        </div>
                        <button class="btn btn-success btn-lg w-100" @onclick="ReturnToCatalog">
                            <i class="bi bi-arrow-left me-2"></i>@L.T("cart_return_catalog")
                        </button>
                    </div>
                }
                else
                {
                    <div class="result-content error">
                        <div class="result-icon error-icon">
                            <i class="bi bi-x-circle-fill"></i>
                        </div>
                        <h3 class="result-title">@L.T("cart_order_error")</h3>
                        <p class="result-message">@orderErrorMessage</p>
                        <div class="result-buttons">
                            <button class="btn btn-primary me-2" @onclick="RetryOrder">
                                <i class="bi bi-arrow-clockwise me-2"></i>@L.T("cart_retry")
                            </button>
                            <button class="btn btn-outline-secondary" @onclick="ReturnToCatalog">
                                <i class="bi bi-arrow-left me-2"></i>@L.T("cart_return_catalog")
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <div class="row g-4">
        <!-- COLUMNA IZQUIERDA: Productos -->
        <div class="col-12 col-lg-8">

            <!-- PACKS PROMOCIONALES -->
            @if (GetPackGroups().Any())
            {
                <div class="card mb-4 border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-gift-fill me-2"></i>
                            @L.T("cart_promo_packs")
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        @foreach (var packGroup in GetPackGroups())
                        {
                            var firstItem = packGroup.Value.First();
                            var packTotal = packGroup.Value.Sum(i => i.SubtotalWithDiscount);

                            <div class="pack-group">
                                <!-- Cabecera del pack -->
                                <div class="pack-header">
                                    <div class="pack-info">
                                        <i class="bi bi-box-seam me-2"></i>
                                        <strong>@firstItem.PackDescription</strong>
                                        <span class="badge bg-danger ms-2">@L.T("cart_pack")</span>
                                    </div>
                                    <div class="pack-actions">
                                        <span class="pack-total me-3">@packTotal.ToString("0.00") €</span>
                                        <button class="btn btn-link btn-sm text-danger p-0"
                                                @onclick="(() => RemovePackConfirm(packGroup.Key, firstItem.PackDescription))">
                                            <i class="bi bi-trash"></i> @L.T("cart_remove_pack")
                                        </button>
                                    </div>
                                </div>

                                <!-- Items del pack -->
                                <div class="pack-items">
                                    @foreach (var item in packGroup.Value)
                                    {
                                        <div class="pack-item-row">
                                            <img src="@(!string.IsNullOrWhiteSpace(item.Product.ImageUrl) ? item.Product.ImageUrl : "/images/image.png")"
                                                 class="pack-item-image"
                                                 alt="@item.Product.Name"
                                                 onerror="this.style.display='none'"
                                                 loading="lazy">

                                            <div class="pack-item-details">
                                                <span class="pack-item-name">@item.Product.Name</span>
                                                <span class="pack-item-type">
                                                    @if (item.IsPackGift)
                                                    {
                                                        <span class="badge bg-success">@L.T("cart_gift")</span>
                                                    }
                                                    else if (item.DescuentoProducto > 0)
                                                    {
                                                        <span class="badge bg-warning text-dark">-@item.DescuentoProducto.ToString("0")%</span>
                                                    }
                                                </span>
                                            </div>

                                            <div class="pack-item-pricing">
                                                <span class="item-quantity">@item.Quantity x</span>
                                                @if (item.DescuentoProducto > 0)
                                                {
                                                    <span class="text-muted text-decoration-line-through me-1" style="font-size: 0.85em;">
                                                        @item.Product.PriceFrom.ToString("0.00")€
                                                    </span>
                                                }
                                                <span class="item-price">@item.PriceWithDiscount.ToString("0.00")€</span>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- PRODUCTOS NORMALES (sin pack) -->
            @if (GetNormalItems().Any())
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-cart me-2"></i>
                            @L.T("cart_products")
                        </h5>
                    </div>
                    <div class="card-body">
                        @foreach (var item in GetNormalItems())
                        {
                            <div class="cart-item">
                                <img src="@(!string.IsNullOrWhiteSpace(item.Product.ImageUrl) ? item.Product.ImageUrl : "/images/image.png")"
                                     class="cart-item-image"
                                     alt="@item.Product.Name"
                                     onerror="this.style.display='none'"
                                     loading="lazy">

                                <div class="cart-item-content">
                                    <div class="cart-item-info">
                                        <a href="@($"/producto/{item.Product.Slug}")" class="cart-item-name">
                                            @item.Product.Name
                                        </a>
                                        <div class="cart-item-details">
                                            @if (item.DescuentoProducto > 0)
                                            {
                                                <span class="text-decoration-line-through text-muted me-1">
                                                    @item.Product.PriceFrom.ToString("N2") €
                                                </span>
                                                <span class="text-danger fw-semibold">
                                                    @item.PriceWithDiscount.ToString("N2") €
                                                </span>
                                                <span class="badge bg-danger ms-2">-@item.DescuentoProducto.ToString("0.##")%</span>
                                            }
                                            else
                                            {
                                                <span>@item.Product.PriceFrom.ToString("N2") €</span>
                                            }
                                            <span class="mx-1">×</span>
                                            <span>@item.Product.Presentation_Unit</span>
                                        </div>
                                    </div>

                                    <div class="cart-item-price-section">
                                        <div class="cart-item-price">
                                            @item.SubtotalWithDiscount.ToString("0.00") €
                                        </div>
                                        <div class="cart-item-quantity">
                                            <QuantityStepper Value="item.Quantity" ValueChanged="(v) => Change(item, v)" />
                                        </div>
                                    </div>

                                    <div class="cart-item-actions">
                                        <button class="btn btn-link btn-sm text-danger p-0" @onclick="(() => Remove(item))">
                                            <i class="bi bi-trash me-1"></i>@L.T("cart_remove")
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- MATERIAL PROMOCIONAL -->
            @if (PctDescMaterialProm > 0)
            {
                <div class="card mb-4 border-info">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-megaphone-fill me-2"></i>
                            @L.T("promo_material_title")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle me-1"></i>
                            @L.T("promo_material_budget", MaxPromoBudget.ToString("0.00"))
                            <strong>(@L.T("promo_material_remaining", PromoRemaining.ToString("0.00")))</strong>
                        </div>

                        @if (promoMaterialProducts != null && promoMaterialProducts.Any())
                        {
                            <div class="promo-material-list">
                                @foreach (var prod in promoMaterialProducts)
                                {
                                    <div class="promo-material-item">
                                        <img src="@(!string.IsNullOrWhiteSpace(prod.ImageUrl) ? prod.ImageUrl : "/images/image.png")"
                                             class="promo-material-img"
                                             alt="@prod.Name"
                                             onerror="this.style.display='none'"
                                             loading="lazy">
                                        <div class="promo-material-info">
                                            <span class="fw-semibold">@prod.Name</span>
                                            <span class="text-muted small">@prod.PriceFrom.ToString("0.00") €</span>
                                        </div>
                                        <div class="promo-material-actions">
                                            <input type="number" min="1" max="50"
                                                   class="form-control form-control-sm"
                                                   style="width: 70px;"
                                                   @bind="promoQuantities[prod.Itemno]" />
                                            <button class="btn btn-sm btn-info text-white ms-2"
                                                    disabled="@(!CanAddPromoMaterial(prod))"
                                                    @onclick="(() => AddPromoMaterial(prod))">
                                                <i class="bi bi-plus-circle me-1"></i>@L.T("promo_material_add")
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        }

                        @if (Cart.GetPromotionalMaterialInCart().Any())
                        {
                            <hr />
                            <h6>@L.T("promo_material_title") @L.T("cart_products"):</h6>
                            @foreach (var promoItem in Cart.GetPromotionalMaterialInCart())
                            {
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>@promoItem.Product.Name x @promoItem.Quantity</span>
                                    <span class="badge bg-success">@L.T("cart_gift")</span>
                                </div>
                            }
                        }

                        @if (promoExceeded)
                        {
                            <div class="alert alert-warning mt-2 mb-0">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                @L.T("promo_material_exceeded")
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- CREDITO ATLETA -->
            @if (IsAtleta && CreditoAnualAtleta > 0)
            {
                <div class="card mb-4 border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-trophy-fill me-2"></i>
                            @L.T("athlete_credit_title")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>@L.T("athlete_credit_available")</span>
                            <strong class="text-warning fs-5">@CreditoRestante.ToString("0.00") €</strong>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="useAthleteCredit"
                                   checked="@useAthleteCredit"
                                   @onchange="ToggleAthleteCredit" />
                            <label class="form-check-label" for="useAthleteCredit">
                                @L.T("athlete_credit_apply")
                            </label>
                        </div>

                        @if (useAthleteCredit && Cart.AthleteCreditApplied > 0)
                        {
                            <div class="alert alert-success mb-0">
                                <div class="d-flex justify-content-between">
                                    <span>@L.T("athlete_credit_applied")</span>
                                    <strong>@Cart.AthleteCreditApplied.ToString("0.00") €</strong>
                                </div>
                                <div class="d-flex justify-content-between mt-1">
                                    <span>@L.T("athlete_credit_remaining_pay")</span>
                                    <strong>@((Cart.ImporteTotal).ToString("0.00")) €</strong>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- DIRECCIÓN DE ENVÍO -->
            <div class="card shipping-address-card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-truck me-2"></i>
                        @L.T("cart_shipping_address")
                    </h5>
                </div>
                <div class="card-body">
                    @if (Auth.CurrentUser?.CustomerAddres?.Any() == true)
                    {
                        <div class="mb-3">
                            <label class="form-label fw-semibold">@L.T("cart_select_address")</label>
                            <select class="form-select" @bind="selectedAddressId" @bind:after="OnAddressSelectionChanged">
                                <option value="">@L.T("cart_select_address_placeholder")</option>
                                @foreach (var address in Auth.CurrentUser.CustomerAddres)
                                {
                                    <option value="@address.Code">
                                        @GetAddressDisplayText(address)
                                    </option>
                                }
                            </select>
                        </div>

                        @if (!string.IsNullOrEmpty(selectedAddressId))
                        {
                            var selectedAddress = Auth.CurrentUser.CustomerAddres.FirstOrDefault(a => a.Code == selectedAddressId);
                            if (selectedAddress != null)
                            {
                                <div class="selected-address">
                                    <div class="address-icon">
                                        <i class="bi bi-geo-alt-fill"></i>
                                    </div>
                                    <div class="address-details">
                                        <div class="address-name">@selectedAddress.Name @selectedAddress.Name2</div>
                                        <div class="address-full">
                                            @selectedAddress.Address<br />
                                            @selectedAddress.County<br />
                                            @selectedAddress.City, @selectedAddress.PostCode
                                        </div>
                                        @if (!string.IsNullOrEmpty(selectedAddress.Contact))
                                        {
                                            <div class="address-contact mt-2">
                                                <i class="bi bi-person-fill me-1"></i>@selectedAddress.Contact
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(selectedAddress.MobileNumber))
                                        {
                                            <div class="address-phone">
                                                <i class="bi bi-telephone-fill me-1"></i>@selectedAddress.MobileNumber
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        }
                    }
                    else
                    {
                        <div class="no-address-notice">
                            <div class="notice-icon">
                                <i class="bi bi-info-circle"></i>
                            </div>
                            <div class="notice-text">
                                <strong>@L.T("cart_no_addresses")</strong>
                                <p class="mb-0 text-muted">@L.T("cart_no_addresses_text")</p>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- OBSERVACIONES -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-chat-left-text me-2"></i>
                        @L.T("cart_observations")
                    </h5>
                </div>
                <div class="card-body">
                    <textarea class="form-control"
                              rows="4"
                              placeholder="@L.T("cart_observations_placeholder")"
                              @bind="Cart.Observaciones"
                              style="resize: vertical;"></textarea>
                    <small class="form-text text-muted mt-2 d-block">
                        <i class="bi bi-info-circle me-1"></i>
                        @L.T("cart_observations_hint")
                    </small>
                </div>
            </div>
        </div>

        <!-- COLUMNA DERECHA: Resumen -->
        <div class="col-12 col-lg-4">
            <div class="card sticky-lg-top" style="top: 100px;">
                <div class="card-body">
                    <h5 class="mb-3">@L.T("cart_summary")</h5>

                    <div class="d-flex justify-content-between mb-2">
                        <span>@L.T("cart_items")</span>
                        <strong>@Cart.TotalQuantity</strong>
                    </div>

                    <hr class="my-2">

                    <div class="d-flex justify-content-between mb-2">
                        <span>@L.T("cart_subtotal")</span>
                        <span>@Cart.BaseImponible.ToString("0.00") €</span>
                    </div>

                    @if (Cart.DescuentoProductos > 0)
                    {
                        <div class="d-flex justify-content-between mb-2 text-danger">
                            <span>
                                <i class="bi bi-tag-fill me-1"></i>
                                @L.T("cart_product_discounts")
                            </span>
                            <span>-@Cart.DescuentoProductos.ToString("0.00") €</span>
                        </div>
                    }

                    @if (Cart.DescuentoFactura > 0)
                    {
                        <div class="d-flex justify-content-between mb-2 text-success">
                            <span>
                                <i class="bi bi-tag-fill me-1"></i>
                                @L.T("cart_discount") (@Auth.CurrentUser.DescuentoFactura.ToString("0.##")%)
                            </span>
                            <span>-@Cart.DescuentoFactura.ToString("0.00") €</span>
                        </div>

                        <div class="d-flex justify-content-between mb-2">
                            <span class="fw-semibold">@L.T("cart_subtotal_after_discount")</span>
                            <span class="fw-semibold">@Cart.BaseImponibleConDescuento.ToString("0.00") €</span>
                        </div>
                    }

                    <div class="d-flex justify-content-between mb-3">
                        <span>@L.T("cart_vat")</span>
                        <span>@Cart.TotalVat.ToString("0.00") €</span>
                    </div>

                    <hr class="my-3">

                    <div class="d-flex justify-content-between mb-3">
                        <span class="h5 mb-0">@L.T("cart_total")</span>
                        <strong class="h4 text-danger mb-0">@Cart.ImporteTotal.ToString("0.00") €</strong>
                    </div>

                    <!-- Banner atleta sin pedido minimo -->
                    @if (IsAtleta && LimitePedido > 0)
                    {
                        <div class="alert alert-warning py-2 mb-3">
                            <i class="bi bi-trophy-fill me-1"></i>
                            <small>@L.T("athlete_no_minimum_order")</small>
                        </div>
                    }

                    <!-- Barra de progreso hacia el mínimo -->
                    @if (LimitePedido > 0 && !MeetsMinimumOrder && !IsAtleta)
                    {
                        <div class="minimum-order-warning mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small text-warning-emphasis">
                                    <i class="bi bi-info-circle me-1"></i>@L.T("cart_minimum_order")
                                </span>
                                <span class="small fw-semibold">
                                    @Cart.ImporteTotal.ToString("0.00") € / @LimitePedido.ToString("0.00") €
                                </span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-warning"
                                     role="progressbar"
                                     style="width: @ProgressPercentage%"
                                     aria-valuenow="@ProgressPercentage"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                </div>
                            </div>
                            <div class="text-center mt-2 small text-warning-emphasis">
                                <i class="bi bi-cart-plus me-1"></i>
                                @L.T("cart_missing_amount", AmountToMinimum.ToString("0.00"))
                            </div>
                        </div>
                    }

                    <button class="btn btn-danger w-100 mt-3"
                            @onclick="Checkout"
                            disabled="@(!CanProceedToCheckout)">
                        <i class="bi bi-cart-check me-2"></i>
                        @L.T("cart_process_order")
                    </button>

                    <div class="form-text mt-2 text-center">
                        @if (!MeetsMinimumOrder && LimitePedido > 0)
                        {
                            <span class="text-danger small">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                @L.T("cart_minimum_warning", LimitePedido.ToString("0.00"))
                            </span>
                        }
                        else if (!CanProceedToCheckout && Auth.CurrentUser?.CustomerAddres?.Any() == true)
                        {
                            <span class="text-warning small">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                @L.T("cart_select_address_warning")
                            </span>
                        }
                    </div>
                </div>
            </div>

            <!-- Card informativa del pedido mínimo -->
            @if (LimitePedido > 0 && !IsAtleta)
            {
                <div class="card mt-3 @(MeetsMinimumOrder ? "border-success" : "border-warning")">
                    <div class="card-body py-3">
                        <div class="d-flex align-items-center">
                            @if (MeetsMinimumOrder)
                            {
                                <i class="bi bi-check-circle-fill text-success fs-4 me-3"></i>
                                <div>
                                    <h6 class="mb-0 text-success">@L.T("cart_minimum_reached")</h6>
                                    <small class="text-muted">@L.T("cart_minimum_exceeded", LimitePedido.ToString("0.00"))</small>
                                </div>
                            }
                            else
                            {
                                <i class="bi bi-exclamation-triangle-fill text-warning fs-4 me-3"></i>
                                <div>
                                    <h6 class="mb-0 text-warning">@L.T("cart_minimum_not_reached")</h6>
                                    <small class="text-muted">@L.T("cart_add_more", AmountToMinimum.ToString("0.00"))</small>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Info adicional del descuento -->
            @if (Auth.CurrentUser?.DescuentoFactura > 0)
            {
                <div class="card mt-3 border-success">
                    <div class="card-body py-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-percent text-success fs-4 me-3"></i>
                            <div>
                                <h6 class="mb-0">@L.T("cart_discount_applied")</h6>
                                <small class="text-muted">
                                    @L.T("cart_discount_info", Auth.CurrentUser.DescuentoFactura.ToString("0.##"))
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}

<style>
    /* ========================================
           ESTILOS DE PACKS PROMOCIONALES
           ======================================== */
    .pack-group {
        border-bottom: 1px solid #e9ecef;
    }

        .pack-group:last-child {
            border-bottom: none;
        }

    .pack-header {
        background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #dc3545;
    }

    .pack-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.1rem;
        color: #2c3e50;
    }

    .pack-actions {
        display: flex;
        align-items: center;
    }

    .pack-total {
        font-size: 1.25rem;
        font-weight: 700;
        color: #dc3545;
    }

    .pack-items {
        padding: 1rem;
        background: #fafafa;
    }

    .pack-item-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        background: white;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

        .pack-item-row:last-child {
            margin-bottom: 0;
        }

    .pack-item-image {
        width: 60px;
        height: 60px;
        object-fit: contain;
        border-radius: 6px;
        flex-shrink: 0;
    }

    .pack-item-details {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .pack-item-name {
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.95rem;
    }

    .pack-item-pricing {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        flex-shrink: 0;
    }

    .item-quantity {
        color: #6c757d;
    }

    .item-price {
        color: #dc3545;
        font-size: 1.1rem;
    }

    /* ========================================
           ESTILOS LÍMITE MÍNIMO
           ======================================== */
    .minimum-order-warning {
        background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 0.75rem 1rem;
    }

        .minimum-order-warning .progress {
            background-color: rgba(255, 193, 7, 0.3);
        }

        .minimum-order-warning .progress-bar {
            background: linear-gradient(90deg, #ffc107 0%, #ff9800 100%);
        }

    /* ========================================
           ESTILOS DIRECCIÓN SELECCIONADA
           ======================================== */
    .selected-address {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #dc3545;
    }

    .address-icon {
        font-size: 1.5rem;
        color: #dc3545;
    }

    .address-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .address-full {
        color: #6c757d;
        font-size: 0.9rem;
    }

    .no-address-notice {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        background: #e7f3ff;
        border-radius: 8px;
    }

    .notice-icon {
        font-size: 1.5rem;
        color: #0d6efd;
    }

    /* ========================================
           MATERIAL PROMOCIONAL
           ======================================== */
    .promo-material-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .promo-material-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .promo-material-img {
        width: 50px;
        height: 50px;
        object-fit: contain;
        border-radius: 6px;
        flex-shrink: 0;
    }

    .promo-material-info {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    .promo-material-actions {
        display: flex;
        align-items: center;
        flex-shrink: 0;
    }

    /* ========================================
           RESPONSIVE
           ======================================== */
    @@media (max-width: 768px) {
        .pack-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .pack-actions {
            width: 100%;
            justify-content: space-between;
        }

        .pack-item-row {
            flex-wrap: wrap;
        }

        .pack-item-details {
            flex: 1;
            min-width: 120px;
        }

        .pack-item-pricing {
            width: 100%;
            justify-content: flex-end;
            margin-top: 0.5rem;
        }

        .selected-address {
            flex-direction: column;
            gap: 0.5rem;
        }
    }
</style>

@code {
    private string selectedAddressId = "";
    private bool isProcessingOrder = false;
    private bool orderCompleted = false;
    private bool orderSuccess = false;
    private string orderErrorMessage = "";

    // Propiedades para tipo de cliente
    private bool IsAtleta => Auth.CurrentUser?.TipoClienteWebShop == "Atleta"
        || Auth.CurrentCustomer?.TipoClienteWebShop == "Atleta";

    // Propiedades para el límite mínimo de pedido
    private decimal LimitePedido => ApiSettings.Value.LimitePedido;
    private bool MeetsMinimumOrder => IsAtleta || LimitePedido <= 0 || Cart.ImporteTotal >= LimitePedido;
    private decimal AmountToMinimum => Math.Max(0, LimitePedido - Cart.ImporteTotal);
    private double ProgressPercentage => LimitePedido > 0
        ? Math.Min(100, (double)(Cart.ImporteTotal / LimitePedido) * 100)
        : 100;

    // Verificar si un item es parte de un pack
    private bool IsPartOfPack(CartItem item) => !string.IsNullOrWhiteSpace(item.PackId);

    // Validación para proceder al checkout
    private bool CanProceedToCheckout =>
        MeetsMinimumOrder &&
        (Auth.CurrentUser?.CustomerAddres?.Any() != true || !string.IsNullOrEmpty(selectedAddressId));

    // Agrupar items por pack
    private Dictionary<string, List<CartItem>> GetPackGroups()
    {
        return Cart.Items
            .Where(i => !string.IsNullOrWhiteSpace(i.PackId))
            .GroupBy(i => i.PackId)
            .ToDictionary(g => g.Key!, g => g.ToList());
    }

    // Obtener items normales (sin pack)
    private List<CartItem> GetNormalItems()
    {
        return Cart.Items
            .Where(i => string.IsNullOrWhiteSpace(i.PackId))
            .ToList();
    }

    // Material Promocional
    private decimal PctDescMaterialProm => Auth.CurrentUser?.PctDescMaterialProm
        ?? Auth.CurrentCustomer?.PctDescMaterialProm ?? 0;
    private decimal MaxPromoBudget => Cart.BaseImponible * (PctDescMaterialProm / 100);
    private decimal PromoConsumed => Cart.PromotionalMaterialTotal;
    private decimal PromoRemaining => Math.Max(0, MaxPromoBudget - PromoConsumed);
    private bool promoExceeded => PromoConsumed > MaxPromoBudget && MaxPromoBudget > 0;
    private List<Product>? promoMaterialProducts;
    private Dictionary<string, int> promoQuantities = new();

    // Credito Atleta
    private decimal CreditoAnualAtleta => Auth.CurrentUser?.CreditoAnualAtleta
        ?? Auth.CurrentCustomer?.CreditoAnualAtleta ?? 0;
    private decimal CreditoConsumidoAtleta => Auth.CurrentUser?.CreditoConsumidoAtleta
        ?? Auth.CurrentCustomer?.CreditoConsumidoAtleta ?? 0;
    private decimal CreditoRestante => Math.Max(0, CreditoAnualAtleta - CreditoConsumidoAtleta);
    private bool useAthleteCredit = false;

    private bool CanAddPromoMaterial(Product prod)
    {
        int qty = promoQuantities.ContainsKey(prod.Itemno) ? promoQuantities[prod.Itemno] : 1;
        decimal cost = prod.PriceFrom * qty;
        return cost <= PromoRemaining;
    }

    private async Task AddPromoMaterial(Product prod)
    {
        int qty = promoQuantities.ContainsKey(prod.Itemno) ? promoQuantities[prod.Itemno] : 1;
        decimal cost = prod.PriceFrom * qty;
        if (cost > PromoRemaining) return;

        await Cart.AddPromotionalMaterial(prod, qty);
        StateHasChanged();
    }

    private async Task ToggleAthleteCredit(ChangeEventArgs e)
    {
        useAthleteCredit = (bool)(e.Value ?? false);
        if (useAthleteCredit)
        {
            await Cart.ApplyAthleteCredit(CreditoRestante);
        }
        else
        {
            await Cart.RemoveAthleteCredit();
        }
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        Auth.OnCustomerChanged += OnCustomerChanged;
        L.OnLanguageChanged += OnLanguageChanged;

        // Cargar productos de material promocional
        try
        {
            promoMaterialProducts = await Products.GetMaterialPromocionalAsync();
            foreach (var p in promoMaterialProducts)
            {
                promoQuantities[p.Itemno] = 1;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Carrito] Error cargando material promocional: {ex.Message}");
            promoMaterialProducts = new();
        }
    }

    private void OnLanguageChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    // Handler cuando cambia el cliente (para usuarios del equipo comercial)
    private async Task OnCustomerChanged()
    {
        Console.WriteLine("[Carrito] Cliente cambió, limpiando estado");
        selectedAddressId = "";
        isProcessingOrder = false;
        orderCompleted = false;
        orderSuccess = false;
        orderErrorMessage = "";
        await InvokeAsync(StateHasChanged);
    }

    // Confirmar eliminación de pack completo
    private async Task RemovePackConfirm(string packId, string? packDescription)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm",
            L.T("cart_confirm_remove_pack", packDescription ?? "Promocional"));

        if (confirmed)
        {
            await Cart.RemovePack(packId);
        }
    }

    // Cambiar cantidad de un item
    async Task Change(CartItem item, int qty)
    {
        if (IsPartOfPack(item))
        {
            await JS.InvokeVoidAsync("showToast", "warning", L.T("cart_pack"),
                L.T("cart_pack_warning"));
            return;
        }

        await Cart.Update(item.Product.Id, qty, item.DescuentoProducto);
    }

    // Eliminar un item
    async Task Remove(CartItem item)
    {
        if (IsPartOfPack(item))
        {
            var confirmed = await JS.InvokeAsync<bool>("confirm",
                L.T("cart_confirm_remove_from_pack", item.PackDescription ?? ""));

            if (confirmed)
            {
                await Cart.RemovePack(item.PackId!);
            }
        }
        else
        {
            await Cart.Remove(item.Product.Id, item.DescuentoProducto);
        }
    }

    // Procesar pedido
    async Task Checkout()
    {
        // Validación adicional del límite mínimo
        if (!MeetsMinimumOrder)
        {
            await JS.InvokeVoidAsync("showToast", "error", L.T("cart_minimum_order"),
                L.T("cart_minimum_warning", LimitePedido.ToString("0.00")));
            return;
        }

        isProcessingOrder = true;
        orderCompleted = false;
        StateHasChanged();

        try
        {
            // Calcular credito atleta consumido ANTES de enviar (el carrito se puede limpiar despues)
            decimal athleteCreditUsed = Cart.AthleteCreditApplied;

            var success = await Cart.ProcessOrder(Cart.Items, selectedAddressId,
                Auth.CurrentUser!.Email, Auth.CurrentUser.CustomerNo);

            orderSuccess = success.IsSuccess;
            if (!orderSuccess)
            {
                orderErrorMessage = success.Message;
            }
            else if (athleteCreditUsed > 0)
            {
                // Sincronizar credito consumido localmente para pedidos siguientes
                if (Auth.CurrentUser != null)
                    Auth.CurrentUser.CreditoConsumidoAtleta += athleteCreditUsed;
                if (Auth.CurrentCustomer != null)
                    Auth.CurrentCustomer.CreditoConsumidoAtleta += athleteCreditUsed;
            }
        }
        catch (Exception ex)
        {
            orderSuccess = false;
            orderErrorMessage = $"Error de conexión: {ex.Message}";
        }
        finally
        {
            isProcessingOrder = false;
            orderCompleted = true;
            StateHasChanged();
        }
    }

    private void OnAddressSelectionChanged()
    {
        StateHasChanged();
    }

    private string GetAddressDisplayText(CustomerAddres address)
    {
        var displayText = $"{address.Name}";
        if (!string.IsNullOrEmpty(address.Name2))
            displayText += $" {address.Name2}";
        displayText += $" - {address.City}";
        displayText += $" - {address.Code}";

        if (!string.IsNullOrEmpty(address.AddressType))
            displayText += $" ({address.AddressType})";

        return displayText;
    }

    private async Task ReturnToCatalog()
    {
        await Cart.Clear();
        Nav.NavigateTo("/catalogo");
    }

    private void RetryOrder()
    {
        orderCompleted = false;
        orderSuccess = false;
        orderErrorMessage = "";
        StateHasChanged();
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        Auth.OnCustomerChanged -= OnCustomerChanged;
        L.OnLanguageChanged -= OnLanguageChanged;
        await ValueTask.CompletedTask;
    }
}
