@page "/buscar"
@inject NavigationManager Nav
@inject ProductService Products
@inject AuthService Auth
@inject LocalizationService L
@implements IDisposable

<h1 class="mb-3">@L.T("search_title")</h1>

@if (items is null)
{
    <div class="text-center p-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">@L.T("loading")</span>
        </div>
        <p class="mt-2">@L.T("search_loading")</p>
    </div>
}
else if (!items.Any())
{
    <div class="alert alert-info">
        <i class="bi bi-search me-2"></i>
        @L.T("search_no_results") <strong>@q</strong>
    </div>
}
else
{
    <div class="search-results-info mb-3">
        <p class="text-muted">
            @L.T("search_results_count", items.Count()) "<strong>@q</strong>"
        </p>
    </div>

    <ProductGrid Data="items" @key="@GetSearchKey()" />
}

@code {

    private string? q;
    private string mode = "product";
    private IEnumerable<Product>? items;

    // ✅ Ciclo de vida
    protected override async Task OnInitializedAsync()
    {
        Auth.OnCustomerChanged += OnCustomerChanged;
        L.OnLanguageChanged += OnLanguageChanged;
        Nav.LocationChanged += OnLocationChanged;
        await LoadSearchResultsAsync();
    }

    private void OnLanguageChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        if (new Uri(e.Location).AbsolutePath.Equals("/buscar", StringComparison.OrdinalIgnoreCase))
        {
            await LoadSearchResultsAsync();
            await InvokeAsync(StateHasChanged);
        }
    }

    // ✅ NUEVO: Método para cargar resultados de búsqueda
    private async Task LoadSearchResultsAsync()
    {
        try
        {
            var uri = new Uri(Nav.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            q = query.Get("q") ?? "";
            mode = query.Get("mode") ?? "product";

            Console.WriteLine($"[Buscar] Buscando: '{q}' (modo: {mode}) para cliente: {Auth.CurrentCustomer?.CustNo ?? Auth.CurrentUser?.CustomerNo}");

            items = null;
            var all = await Products.GetAllAsync();

            items = mode switch
            {
                "ingredient" => all.Where(p =>
                    p.Description.Contains(q, StringComparison.OrdinalIgnoreCase)
                ).ToList(),
                _ => all.Where(p =>
                    p.Name.Contains(q, StringComparison.OrdinalIgnoreCase) ||
                    p.EAN13.Contains(q, StringComparison.OrdinalIgnoreCase)
                ).ToList()
            };

            Console.WriteLine($"[Buscar] Encontrados {items.Count()} resultados");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ERROR Buscar.LoadSearchResultsAsync] {ex.Message}");
            items = new List<Product>();
        }
    }

    // ✅ NUEVO: Handler para cambio de cliente
    private async Task OnCustomerChanged()
    {
        Console.WriteLine("[Buscar.OnCustomerChanged] Cliente cambió, refrescando búsqueda");
        await LoadSearchResultsAsync();
        await InvokeAsync(StateHasChanged);
        Console.WriteLine($"[Buscar.OnCustomerChanged] Búsqueda completada - Resultados: {items?.Count()}");
    }

    // ✅ NUEVO: Clave dinámica que incluye el cliente
    private string GetSearchKey()
    {
        var clientId = Auth.CurrentCustomer?.CustNo ?? Auth.CurrentUser?.CustomerNo ?? "default";
        return $"search-{q}-{clientId}";
    }

    // ✅ Cleanup
    public void Dispose()
    {
        Auth.OnCustomerChanged -= OnCustomerChanged;
        L.OnLanguageChanged -= OnLanguageChanged;
        Nav.LocationChanged -= OnLocationChanged;
    }
}
